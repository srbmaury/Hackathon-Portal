name: PR Summary Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - master

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better diffs

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For push events, find the PR number
            PR_NUMBER=$(gh pr list --head ${{ github.ref_name }} --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -z "$PR_NUMBER" ]; then
              echo "No PR found for this branch. Skipping comment updates."
              echo "number=" >> $GITHUB_OUTPUT
            else
              echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Summary
        id: summary
        run: |
          # Get statistics
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l | tr -d ' ')
          TOTAL_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum+0}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum+0}')
          
          # Get recent commits (last 5 only)
          RECENT_COMMITS=$(git log --oneline origin/${{ github.base_ref }}..HEAD | head -5)
          
          # Categorize changed files
          TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(test|spec)" | wc -l | tr -d ' ')
          COMPONENT_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(components|pages)" | wc -l | tr -d ' ')
          API_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "api/" | wc -l | tr -d ' ')
          CONFIG_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(\.yml|\.yaml|\.json|config)" | wc -l | tr -d ' ')
          
          # Get file list (max 10 files, formatted as list)
          CHANGED_FILE_LIST=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -10 | while read file; do echo "- \`$file\`"; done)
          
          # Generate concise summary
          cat > summary.md << EOF
          ## ğŸ“Š PR Summary
          
          **ğŸ“ˆ Stats:** \`$CHANGED_FILES\` files changed | \`+$ADDITIONS\` / \`-$DELETIONS\` lines | \`$TOTAL_COMMITS\` commits
          
          **ğŸ“¦ Changes:**
          - ğŸ§ª Tests: \`$TEST_FILES\` files
          - ğŸ¨ Components/Pages: \`$COMPONENT_FILES\` files  
          - ğŸ”Œ API: \`$API_FILES\` files
          - âš™ï¸ Config: \`$CONFIG_FILES\` files
          
          **ğŸ“ Recent Commits:**
          \`\`\`
          $RECENT_COMMITS
          \`\`\`
          
          **ğŸ“ Key Files Changed:**
          $CHANGED_FILE_LIST
          $([ "$CHANGED_FILES" -gt 10 ] && echo "\n_... and $((CHANGED_FILES - 10)) more files_")
          
          ---
          _Auto-updated â€¢ Tests running..._
          EOF
          
          # Save for next step
          cat summary.md > $GITHUB_STEP_SUMMARY

      - name: Find existing comment
        id: find-comment
        if: steps.pr.outputs.number != ''
        uses: peter-evans/find-comment@v2
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ğŸ“Š PR Summary'

      - name: Update or Create PR Comment
        if: steps.pr.outputs.number != ''
        id: create-comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body-path: summary.md
          edit-mode: replace

      - name: Run Backend Tests
        working-directory: backend
        run: |
          npm ci
          npm test
        continue-on-error: true

      - name: Generate Test Coverage
        working-directory: backend
        run: npm run test:coverage
        continue-on-error: true

      - name: Update Summary with Test Results
        if: always()
        run: |
          # Get test results if available (jq is pre-installed on GitHub runners)
          if [ -f backend/coverage/coverage-summary.json ]; then
            BACKEND_COV=$(jq -r '.total.lines.pct // "N/A"' backend/coverage/coverage-summary.json 2>/dev/null || echo "N/A")
            BACKEND_COV=$(printf "%.1f" "$BACKEND_COV" 2>/dev/null || echo "$BACKEND_COV")
          else
            BACKEND_COV="N/A"
          fi
          
          # Update summary with test results - replace the "Tests running" line
          sed -i 's/_Auto-updated.*Tests running\.\.\._/âœ… **Tests Completed** | Backend Coverage: `'"$BACKEND_COV"'%` | '$(date -u +"%H:%M:%S UTC")'/' summary.md
          
          # Add footer
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "_Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")_" >> summary.md

      - name: Find existing comment again
        id: find-comment-again
        if: always() && steps.pr.outputs.number != ''
        uses: peter-evans/find-comment@v2
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ğŸ“Š PR Summary'

      - name: Update PR Comment with Test Results
        if: always() && steps.pr.outputs.number != ''
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.number }}
          comment-id: ${{ steps.find-comment-again.outputs.comment-id }}
          body-path: summary.md
          edit-mode: replace

